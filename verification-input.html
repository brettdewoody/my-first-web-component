<!-- Defines the web component template -->
<template id="x-verification-input-template">
  <style>
    :host {
      all: initial;
      display: block;
      contain: content;
      box-sizing: border-box;
    }

    * {
      box-sizing: border-box;
    }

    .x-verification-input {
      justify-content: space-between;
      display: flex;
      font-size: 16px;
    }

    .x-verification-field-wrapper {
      flex: 1 1;
      margin-right: -1px;
      border: 1px solid #cccccc;
    }

    .x-verification-field-wrapper:last-child {
      border-top-right-radius: 5px;
      border-bottom-right-radius: 5px;
      margin-right: 0px;
    }

    .x-verification-field-wrapper:first-child {
      border-top-left-radius: 5px;
      border-bottom-left-radius: 5px;
    }

    .x-verification-spacer {
      flex: 1 1;
      font-size: 1.8em;
      text-align: center;
      line-height: 2em;
    }

    .x-verification-field {
      width: 100%;
      font-size: 1.8em;
      line-height: 2em;
      text-align: center;
      border: none;
      border-bottom: 1px solid #222222;
      -moz-appearance:textfield;
      height: 2em;
      padding: 0 0.25em;
      border: none;
      outline: none;
      border-radius: 5px;
    }

    .x-verification-field::-webkit-inner-spin-button,
    .x-verification-field::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

  </style>
  <div class="x-verification-input">
    <div class="x-verification-field-wrapper">
      <input class="x-verification-field" min="0" max="9" type="number" aria-label="Digit 1" />
    </div>
    <div class="x-verification-field-wrapper">
      <input class="x-verification-field" min="0" max="9" type="number" aria-label="Digit 2" />
    </div>
    <div class="x-verification-field-wrapper">
      <input class="x-verification-field" min="0" max="9" type="number" aria-label="Digit 3" />
    </div>
    <div class="x-verification-spacer">
      -
    </div>
    <div class="x-verification-field-wrapper">
      <input class="x-verification-field" min="0" max="9" type="number" aria-label="Digit 4" />
    </div>
    <div class="x-verification-field-wrapper">
      <input class="x-verification-field" min="0" max="9" type="number" aria-label="Digit 5" />
    </div>
    <div class="x-verification-field-wrapper">
      <input class="x-verification-field" min="0" max="9" type="number" aria-label="Digit 6" />
    </div>
  </div>
</template>

<script>
(function(window, document, undefined) {
  // Refers to the "importer"
  const thatDoc = document;

  // Refers to the "importee"
  const thisDoc = (thatDoc._currentScript || thatDoc.currentScript).ownerDocument;

  // Gets content from <template>
  const template = thisDoc.querySelector("#x-verification-input-template").content;

  // Creates an object based in the HTML Element prototype
  class VerificationInput extends HTMLElement {
    // Useful for initializing state, settings up event listeners, or creating shadow dom.
    constructor() {
      super();

      const shadowRoot = this.attachShadow({mode: 'open'});
      shadowRoot.appendChild(template.cloneNode(true));

      this.inputSelector = ".x-verification-field";
      this.inputs = Array.from(this.shadowRoot.querySelectorAll(this.inputSelector));

      //onClick Event Handler
      this.addEventListener("click", event => {
        this.handleClick(shadowRoot);
      })

      // onKeyDown Event Handler
      this.addEventListener("keydown", event => {
        this.handleKeyDown(event, shadowRoot);
      });

      shadowRoot.addEventListener("paste", event => {
        event.preventDefault();
        this.handlePaste(event, shadowRoot);
      });
    }

    handleClick(shadowRoot) {
      if (shadowRoot.activeElement) {
        shadowRoot.activeElement.select();
      }
    }

    handlePaste(event, shadowRoot) {
      event.clipboardData.items[0].getAsString(text => {
        text.split("").slice(0,6).forEach((char, id) => {
          if (Number.isInteger(Number(char))) {
            this.inputs[id].value = Number(char);
          }
        });
      });
    }

    handleKeyDown(event, shadowRoot) {
      switch (shadowRoot.activeElement.tagName) {
        case "INPUT":
          const activeInput = shadowRoot.activeElement;
          const inputVal = activeInput.value;
          const id = this.inputs.findIndex(input => input === activeInput);
          const nextId = (id + 1) % this.inputs.length;
          const prevId = (id + 5) % this.inputs.length;
          const key = String.fromCharCode(event.which);

          // Ignore 'e'
          if (event.keyCode === 69) {
            event.preventDefault();
            return;
          }

          // Handle up arrow key, when value is 9
          if (event.keyCode === 38 && inputVal === "9") {
            event.preventDefault();
            activeInput.value = 0;
            return;
          }

          // Handle down arrow key, when value is 0
          if (event.keyCode === 40 && inputVal === "0") {
            event.preventDefault();
            activeInput.value = 9;
            return;
          }

          // Handle left arrow key
          if (event.keyCode === 37) {
            event.preventDefault();
            this.inputs[prevId].select();
            return;
          }

          // Handle right arrow or tab key
          if (event.keyCode === 39 || event.keyCode === 9) {
            event.preventDefault();
            this.inputs[nextId].select();
            return;
          }

          // Handle the delete or backspace key
          if (event.keyCode === 8 || event.keyCode === 46) {
            event.preventDefault();
            // If already empty, focus on previous input
            if (inputVal === "") {
              this.inputs[prevId].select();
              return;
            }

            // Otherwise, clear input
            activeInput.value = "";
            return;
          }

          // If letter, and not with a metakey
          if (key.match(/[a-z]/i) && !event.metaKey) {
            event.preventDefault();

            // If number
          } else if (Number.isInteger(Number(key))) {
            event.preventDefault();
            // Set the input value
            activeInput.value = key;

            // Move focus to next input
            this.inputs[nextId].select();
            return;
          } else {
            return;
          }

          break;
      }
    }

    // Method to return the code
    getCode() {
      const code = this.inputs.reduce((code, el) => code + el.value, "");
      return code;
    }

    // Method to set the code
    setCode(code) {
      const codeArr = code.toString().split("");
      this.inputs.forEach((input, index) => input.value = codeArr[index]);
      return code;
    }

    // Method to clear the code
    clearCode() {
      this.inputs.forEach((input, index) => input.value = "");
      this.inputs[0].focus();
      return;
    }
  }

  customElements.define('x-verification-input', VerificationInput);
})(window, document);
</script>